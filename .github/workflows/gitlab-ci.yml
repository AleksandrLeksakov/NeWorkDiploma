stages:
  - build

android-build:
  stage: build
  image: openjdk:21-jdk-slim
  variables:
    ANDROID_HOME: /opt/android-sdk
    GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false"
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper/
      - .gradle/caches/
  before_script:
    - apt-get update && apt-get install -y unzip wget zip curl

    # Установка Android SDK
    - mkdir -p $ANDROID_HOME
    - cd $ANDROID_HOME
    - wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
    - unzip commandlinetools-linux-*.zip
    - rm commandlinetools-linux-*.zip
    - mkdir -p cmdline-tools/latest
    - mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
    - rm -rf cmdline-tools/latest/cmdline-tools

    # Лицензии
    - mkdir -p $ANDROID_HOME/licenses
    - echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_HOME/licenses/android-sdk-license
    - echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > $ANDROID_HOME/licenses/android-sdk-preview-license

    # Установка компонентов
    - $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --update
    - $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

    # Создаём local.properties
    - echo "sdk.dir=$ANDROID_HOME" > local.properties
    - cat local.properties

    # Готовим Gradle
    - chmod +x ./gradlew
    - java -version

  script:
    # Создаём secret.properties из переменных GitVerse
    - |
      echo "=== Создаем secret.properties ==="
      echo "API_KEY=$API_KEY" > secret.properties
      echo "MAPKIT_API_KEY=$MAPKIT_API_KEY" >> secret.properties
      cat secret.properties

    # Сборка
    - ./gradlew assembleDebug --stacktrace

    # Проверка APK
    - |
      if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
        echo "APK найден: $(ls -lh app/build/outputs/apk/debug/app-debug.apk | awk '{print $5}')"
        unzip -q app/build/outputs/apk/debug/app-debug.apk classes.dex -d temp_apk/
        if command -v strings &> /dev/null; then
          strings temp_apk/classes.dex | grep -i "api_key\|mapkit" | head -5
        fi
        rm -rf temp_apk/
      else
        echo "❌ Ошибка: APK не найден!"
        exit 1
      fi

  artifacts:
    paths:
      - app/build/outputs/apk/debug/app-debug.apk
    expire_in: 7 days

  rules:
    - if: $CI_COMMIT_REF_NAME == "main"